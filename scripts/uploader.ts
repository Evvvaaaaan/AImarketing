// scripts/uploader.ts
import { google } from 'googleapis';
import fs from 'fs-extra';
import path from 'path';
import chalk from 'chalk';

const CREDENTIALS_PATH = path.join(process.cwd(), 'client_secret.json');
const TOKEN_PATH = path.join(process.cwd(), 'tokens.json');
const STATE_FILE = 'data/state.json';

export async function uploadVideoToYoutube(videoId: string) {
    console.log(chalk.blue(`ğŸš€ ìœ íŠœë¸Œ ì—…ë¡œë“œ ì‹œì‘ (ID: ${videoId})...`));

    // 1. ì˜ìƒ ì •ë³´ ì°¾ê¸°
    const state = await fs.readJSON(STATE_FILE);
    const videoItem = state.find((item: any) => item.id === videoId);

    if (!videoItem) {
        console.error('âŒ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return false;
    }

    // ì—…ë¡œë“œí•  íŒŒì¼ ê²½ë¡œ ê²°ì •
    // 1ìˆœìœ„: finalVideoPath (ë Œë”ë§ëœ ê²°ê³¼ë¬¼)
    // 2ìˆœìœ„: out í´ë”ì˜ ì˜ˆìƒ ê²½ë¡œ (fallback)
    let uploadFilePath = '';

    if (videoItem.finalVideoPath) {
        uploadFilePath = path.join(process.cwd(), videoItem.finalVideoPath);
    } else {
        // í˜¹ì‹œ finalVideoPathê°€ ê¸°ë¡ë˜ì§€ ì•Šì•˜ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„
        uploadFilePath = path.join(process.cwd(), 'out', `${videoId}.mp4`);
    }

    if (!fs.existsSync(uploadFilePath)) {
        console.error(chalk.red(`âŒ ì˜ìƒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${uploadFilePath}`));
        // í˜¹ì‹œ ëª¨ë¥´ë‹ˆ ì›ë³¸(ë°°ê²½)ì´ë¼ë„ ì—…ë¡œë“œ í• ì§€? -> ì•„ë‹ˆì˜¤, ë Œë”ë§ ì•ˆëœê±´ ì˜ë¯¸ ì—†ìŒ.
        return false;
    }

    // 2. ì¸ì¦ ì„¤ì •
    const creds = await fs.readJSON(CREDENTIALS_PATH);
    const tokens = await fs.readJSON(TOKEN_PATH);
    const { client_secret, client_id, redirect_uris } = creds.installed || creds.web;
    const auth = new google.auth.OAuth2(client_id, client_secret, redirect_uris[0]);
    auth.setCredentials(tokens);

    const youtube = google.youtube({ version: 'v3', auth });

    try {
        // 3. ì—…ë¡œë“œ ì‹¤í–‰
        console.log(chalk.gray(`   íŒŒì¼ ì½ëŠ” ì¤‘: ${uploadFilePath}`));

        const res = await youtube.videos.insert({
            part: ['snippet', 'status'],
            requestBody: {
                snippet: {
                    title: `${videoItem.props.title} #Shorts`,
                    description: `${videoItem.props.subtitle}\n\nGenerated by Clawdbot`,
                    tags: ['Shorts', 'AI', 'Automation', 'Marketing'],
                },
                status: {
                    privacyStatus: 'public',
                    selfDeclaredMadeForKids: false,
                },
            },
            media: {
                body: fs.createReadStream(uploadFilePath),
            },
        });

        console.log(chalk.green(`âœ… ì—…ë¡œë“œ ì„±ê³µ! URL: https://youtu.be/${res.data.id}`));

        // ìƒíƒœ ì—…ë°ì´íŠ¸
        videoItem.status = 'uploaded';
        videoItem.platformId = res.data.id;

        // ì¤‘ìš”: ë³€ê²½ëœ ìƒíƒœ ì €ì¥
        await fs.writeJSON(STATE_FILE, state, { spaces: 2 });

        return res.data.id;
    } catch (error: any) {
        console.error('âŒ ì—…ë¡œë“œ ì‹¤íŒ¨:', error.message);
        if (error.response) {
            console.error('   Details:', error.response.data);
        }
        return false;
    }
}